<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Streak Stacker â€” with Strava</title>
  <meta name="description" content="Track daily workouts, build streaks, import activities from Strava." />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#0B1020; --card:#121A2E; --ink:#E5E7EB; --muted:#9CA3AF;
      --brand:#60A5FA; --brand-2:#34D399; --warn:#F59E0B; --danger:#F87171;
      --ring:0 0 0 3px rgba(96,165,250,0.35); --radius:16px; --shadow:0 10px 25px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, #1F2937 0%, var(--bg) 60%) no-repeat;
      background-color:var(--bg);}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:30px;height:30px}
    .logo h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .stats{display:grid;grid-template-columns: repeat(4,1fr);gap:12px;margin:8px 0 4px}
    .stat{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:12px}
    .stat .k{font-size:12px;color:var(--muted)} .stat .v{font-size:22px;font-weight:700;margin-top:4px}
    .btn{background:linear-gradient(180deg, #111827, #0b1223);color:var(--ink);border:1px solid rgba(255,255,255,0.12);
      padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;}
    .btn:hover{box-shadow:var(--ring)} .btn.primary{background:linear-gradient(180deg, #2563EB, #1E40AF);border-color:#1E3A8A}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,0.08)} .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap} .right{margin-left:auto}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input, select, textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
      background:#0a1122;color:var(--ink);outline:none}
    input:focus, select:focus, textarea:focus{box-shadow:var(--ring)} textarea{min-height:90px;resize:vertical}
    .calendar{display:grid;grid-template-columns: repeat(7,1fr);gap:6px;margin-top:12px}
    .cell{aspect-ratio:1 / 1;border-radius:10px;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.08);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      position:relative;font-size:12px;color:var(--muted)}
    .cell[data-done="true"]{background:linear-gradient(180deg, rgba(52,211,153,0.25), rgba(59,130,246,0.15));color:#E7F9F2;border-color:rgba(52,211,153,0.35)}
    .cell .dot{width:6px;height:6px;border-radius:50%;background:var(--brand-2);position:absolute;bottom:6px}
    .cell .d{position:absolute;top:6px;left:6px;font-size:10px;color:var(--muted)}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.10);padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));}
    .progress{height:10px;border-radius:999px;background:#0b1326;border:1px solid rgba(255,255,255,0.08);overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg, var(--brand), var(--brand-2));width:0%}
    .footer{margin-top:24px;font-size:12px;color:var(--muted);text-align:center}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px}
    .section-title h2{margin:0;font-size:16px}
    .empty{font-size:13px;color:var(--muted);padding:8px}
    .log-item{padding:12px;border:1px solid rgba(255,255,255,0.08);border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));display:grid;gap:6px}
    .titlebar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .titlebar .streak{display:inline-flex;gap:6px;align-items:center}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 12c4-8 12-8 16 0" stroke="url(#g1)" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 12c4 8 12 8 16 0" stroke="url(#g2)" stroke-width="2" stroke-linecap="round"/>
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0%" stop-color="#34D399"/><stop offset="100%" stop-color="#60A5FA"/>
            </linearGradient>
            <linearGradient id="g2" x1="0" x2="1">
              <stop offset="0%" stop-color="#60A5FA"/><stop offset="100%" stop-color="#34D399"/>
            </linearGradient>
          </defs>
        </svg>
        <h1>Streak Stacker</h1>
      </div>
      <div class="row">
        <button class="btn small ghost" id="exportBtn">Export</button>
        <button class="btn small ghost" id="importBtn">Import</button>
        <button class="btn small" id="installBtn" title="Install as app">Install</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="titlebar">
          <h2 style="margin:0">Today's Workout</h2>
          <div class="streak pill"><span id="streakEmoji">ðŸ”¥</span> <strong id="streakCount">0</strong>-day streak</div>
          <div class="right pill" title="Your weekly goal progress"><span id="weeklyLabel">Weekly goal</span></div>
        </div>
        <div class="stats">
          <div class="stat"><div class="k">Points</div><div class="v" id="points">0</div></div>
          <div class="stat"><div class="k">Longest Streak</div><div class="v" id="bestStreak">0</div></div>
          <div class="stat"><div class="k">This Week</div><div class="v" id="thisWeek">0/5</div></div>
          <div class="stat"><div class="k">Days This Month</div><div class="v" id="monthDays">0</div></div>
        </div>

        <div class="row" style="margin:8px 0 12px">
          <button class="btn primary" id="completeTodayBtn">âœ” Mark Today Complete</button>
          <button class="btn ghost" id="undoBtn">Undo</button>
          <div class="right row">
            <label for="reminderTime" style="margin:0 8px 0 0">Daily reminder</label>
            <input type="time" id="reminderTime" style="width:auto"/>
            <button class="btn small" id="saveReminder">Save</button>
          </div>
        </div>

        <div class="row">
          <div style="flex:1;min-width:240px">
            <label>Workout type</label>
            <select id="type">
              <option>Walk</option>
              <option>Run</option>
              <option>Bike</option>
              <option>Strength</option>
              <option>Mobility</option>
              <option>Other</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Minutes</label>
            <input id="minutes" type="number" min="0" step="1" placeholder="30"/>
          </div>
          <div style="width:140px">
            <label>Intensity</label>
            <select id="intensity">
              <option>Easy</option>
              <option>Moderate</option>
              <option>Hard</option>
            </select>
          </div>
        </div>
        <label>Notes</label>
        <textarea id="notes" placeholder="How did it go?"></textarea>
      </section>

      <aside class="card">
        <div class="section-title">
          <h2>Badges</h2>
          <span class="pill" id="levelTag">Level 1</span>
        </div>
        <div class="badges" id="badges"></div>
        <div class="section-title" style="margin-top:16px">
          <h2>Integrations</h2>
        </div>
        <div class="row" id="stravaBox">
          <button class="btn small" id="connectStrava">Connect Strava</button>
          <button class="btn small ghost" id="importStrava" disabled>Import last 30 days</button>
          <button class="btn small ghost right" id="disconnectStrava" disabled>Disconnect</button>
          <div class="hint" id="stravaStatus">Not connected</div>
        </div>
        <div class="section-title" style="margin-top:16px">
          <h2>Settings</h2>
        </div>
        <div class="row">
          <label for="weeklyGoal" style="margin:0">Weekly goal</label>
          <select id="weeklyGoal">
            <option value="3">3 days</option>
            <option value="4">4 days</option>
            <option value="5" selected>5 days</option>
            <option value="6">6 days</option>
            <option value="7">7 days</option>
          </select>
          <button class="btn small right" id="resetBtn">Reset All</button>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <div class="section-title">
        <h2>Last 30 Days</h2>
        <div style="width:220px" class="row">
          <div class="progress" style="flex:1"><div id="weeklyProgress"></div></div>
          <span class="pill" id="progressLabel">0%</span>
        </div>
      </div>
      <div class="calendar" id="calendar"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="section-title">
        <h2>Log</h2>
      </div>
      <div id="log"></div>
    </section>

    <div class="footer">
      <p>ðŸ’ª Built to make consistency feel rewarding. Your data stays in your browser (local only).
        When connected to Strava, tokens stay on your device and are used only to fetch your activities.</p>
    </div>
  </div>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const fmt = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const iso = (d) => fmt(d).toISOString().slice(0,10);
  const today = fmt(new Date());
  const storeKey = "streakstacker.v2";
  const state = load();
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; $('#installBtn').disabled = false; });
  $('#installBtn').addEventListener('click', async () => {
    if(!deferredPrompt){ alert('Already installed or not supported.'); return; }
    deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice;
    if(outcome === 'accepted'){ $('#installBtn').textContent = 'Installed'; } deferredPrompt = null;
  });

  function load(){ try { const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null }; } catch(e){ return { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null }; } }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function dayDone(dateISO){ return !!state.days[dateISO]; }

  function calcStreak(){ let d = new Date(); let streak = 0; while(true){ const key = iso(d); if(state.days[key]){ streak++; d.setDate(d.getDate()-1); } else{ break; } } return streak; }
  function countThisWeek(){ const d = new Date(); const day = d.getDay(); const start = new Date(d); start.setDate(d.getDate() - day); let c = 0; for(let i=0;i<7;i++){ const k = iso(new Date(start.getFullYear(), start.getMonth(), start.getDate()+i)); if(state.days[k]) c++; } return c; }
  function countThisMonth(){ const d = new Date(); const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth()+1, 0); let c = 0; for(let i=0;i<end.getDate();i++){ const k = iso(new Date(start.getFullYear(), start.getMonth(), start.getDate()+i)); if(state.days[k]) c++; } return c; }
  function pointsForEntry(mins, intensity){ const base = 10; const dur = Math.min(50, Math.max(0, Number(mins)||0)); const bonus = Math.floor(dur/10)*2; const intMul = intensity==='Hard'? 6 : intensity==='Moderate'? 3 : 1; return base + bonus + intMul; }

  function render(){
    const streak = calcStreak(); $('#streakCount').textContent = streak; $('#streakEmoji').textContent = streak >= 21 ? 'ðŸ”¥' : streak >= 7 ? 'âœ¨' : 'ðŸŒ±';
    $('#bestStreak').textContent = state.best || 0; $('#points').textContent = state.points || 0;
    const tw = countThisWeek(); $('#thisWeek').textContent = `${tw}/${state.weeklyGoal}`; $('#monthDays').textContent = countThisMonth();
    $('#weeklyGoal').value = String(state.weeklyGoal); $('#reminderTime').value = state.reminder || '';
    const pct = Math.min(100, Math.round((tw/Math.max(1,state.weeklyGoal))*100)); $('#weeklyProgress').style.width = pct+'%'; $('#progressLabel').textContent = pct+'%'; $('#weeklyLabel').textContent = `Weekly goal`;
    const cal = $('#calendar'); cal.innerHTML=''; for(let i=29;i>=0;i--){ const d = new Date(); d.setDate(today.getDate()-i); const key = iso(d); const cell = document.createElement('div'); cell.className='cell'; cell.dataset.done = dayDone(key); cell.title = key + (state.days[key] ? ' âœ“' : ''); cell.innerHTML = `<span class="d">${d.getDate()}</span>${state.days[key]?'<span class="dot"></span>':''}`; cal.appendChild(cell); }
    const b = $('#badges'); b.innerHTML=''; const badges = []; if((state.days[iso(today)])) badges.push(['Today âœ…','You showed up.']); if((streak)>=3) badges.push(['3-day Streak','Momentum!']); if((streak)>=7) badges.push(['7-day Streak','One full week.']); if((streak)>=14) badges.push(['14-day Streak','Fortnight flex.']); if((streak)>=21) badges.push(['21-day Streak','Habit installed.']); if((state.points)>=500) badges.push(['500 pts','Halfway to 1k.']); if((state.points)>=1000) badges.push(['1,000 pts','You monster.']); if(badges.length===0){ b.innerHTML = '<div class="empty">No badges yet â€” let\'s earn some.</div>'; } else { badges.forEach(([t,s])=>{ const el = document.createElement('div'); el.className='badge'; el.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 2l2.39 4.84 5.34.78-3.86 3.77.91 5.33L12 14.77 6.22 16.72l.91-5.33L3.27 7.62l5.34-.78L12 2z"></path></svg> <strong>${t}</strong>`; el.title = s; b.appendChild(el); }); }
    const log = $('#log'); log.innerHTML=''; if(!state.logs.length){ log.innerHTML = '<div class="empty">No entries yet.</div>'; } else { state.logs.slice().reverse().forEach(item => { const el = document.createElement('div'); el.className='log-item'; el.innerHTML = `<div class="row"><strong>${item.date}</strong> <span class="pill">${item.type}</span> <span class="pill">${item.minutes} min</span> <span class="pill">${item.intensity}</span> <span class="right pill">+${item.points} pts</span></div><div>${item.notes?item.notes:'<span class="muted">No notes</span>'}</div>`; log.appendChild(el); }); }
    const lvl = Math.floor((state.points||0)/250)+1; $('#levelTag').textContent = `Level ${lvl}`;
    const connected = !!(state.strava && state.strava.access_token && state.strava.expires_at*1000 > Date.now()); $('#importStrava').disabled = !connected; $('#disconnectStrava').disabled = !connected; $('#stravaStatus').textContent = connected ? 'Strava connected' : 'Not connected';
  }

  function addEntry(dateISO, minutes, intensity, type, notes){
    if(state.days[dateISO]) return false;
    const pts = pointsForEntry(minutes, intensity);
    state.days[dateISO] = { minutes:Number(minutes)||0, intensity, type, notes, points:pts };
    state.points = (state.points || 0) + pts;
    state.logs.push({date:dateISO, type, minutes:Number(minutes)||0, intensity, notes, points:pts});
    const streak = calcStreak(); if(streak > (state.best||0)) state.best = streak; return true;
  }
  function addToday(){
    const key = iso(today); if(state.days[key]){ alert('Already logged for today. You can undo if needed.'); return; }
    const minutes = $('#minutes').value || 0; const intensity = $('#intensity').value; const type = $('#type').value; const notes = $('#notes').value.trim();
    if(addEntry(key, minutes, intensity, type, notes)){ save(); render(); maybeNotify('Nice work!', `You kept your streak alive.`); }
  }
  function undoToday(){
    const key = iso(today); if(!state.days[key]){ alert('Nothing to undo for today.'); return; }
    const pts = state.days[key].points || 0; delete state.days[key]; state.points = Math.max(0, (state.points||0) - pts);
    for(let i = state.logs.length - 1; i >= 0; i--){ if(state.logs[i].date === key){ state.logs.splice(i,1); break; } } save(); render();
  }
  function setWeeklyGoal(v){ state.weeklyGoal = Number(v)||5; save(); render(); }
  function exportData(){ const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'streakstacker-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  function importData(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange = () => {
      const file = inp.files[0]; if(!file) return; const fr = new FileReader(); fr.onload = () => { try{ const obj = JSON.parse(fr.result); if(!obj.days) throw new Error('Invalid'); Object.assign(state, obj); save(); render(); } catch(e){ alert('Invalid file.'); } }; fr.readAsText(file);
    }; inp.click();
  }
  function resetAll(){ if(confirm('This will delete all your local data. Continue?')){ localStorage.removeItem(storeKey); Object.assign(state, { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null }); render(); } }
  async function enableNotif(){ if(!('Notification' in window)) return false; if(Notification.permission === 'granted') return true; if(Notification.permission === 'denied') return false; const perm = await Notification.requestPermission(); return perm === 'granted'; }
  function maybeNotify(title, body){ if(!('Notification' in window)) return; if(Notification.permission !== 'granted') return; new Notification(title, { body }); }
  function tickReminder(){ if(!state.reminder) return; const now = new Date(); const [hh, mm] = state.reminder.split(':').map(Number); if(now.getHours() === hh && now.getMinutes() === mm){ if(!dayDone(iso(today))){ maybeNotify('Time to move', 'Quick check-in: knock out your workout and keep the streak alive.'); } } }
  setInterval(tickReminder, 60000);

  function getSiteBase(){ return window.location.origin; }
  function getRedirectURI(){ return getSiteBase() + '/'; }
  function stravaAuthURL(clientId){ const scope = 'read,activity:read_all'; const redirect = encodeURIComponent(getRedirectURI()); return `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirect}&approval_prompt=auto&scope=${encodeURIComponent(scope)}`; }
  async function exchangeCode(code){
    const res = await fetch('/.netlify/functions/strava-token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, redirect_uri: getRedirectURI() }) });
    if(!res.ok){ throw new Error('Token exchange failed'); }
    const data = await res.json(); state.strava = data; save(); render();
  }
  async function refreshTokenIfNeeded(){
    if(!state.strava) return false;
    if(state.strava.expires_at*1000 > Date.now()+60000) return true;
    const res = await fetch('/.netlify/functions/strava-token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ refresh_token: state.strava.refresh_token, grant_type: 'refresh_token' }) });
    if(!res.ok){ return false; } const data = await res.json(); state.strava = data; save(); return true;
  }
  async function importRecentStrava(){
    const ok = await refreshTokenIfNeeded(); if(!ok){ alert('Strava not connected.'); return; }
    const after = Math.floor((Date.now() - 30*24*60*60*1000)/1000);
    const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${after}&per_page=200`, { headers: { Authorization: `Bearer ${state.strava.access_token}` } });
    if(!res.ok){ alert('Failed to fetch activities.'); return; }
    const activities = await res.json();
    let added = 0;
    activities.forEach(act => {
      const start = new Date(act.start_date_local || act.start_date);
      const key = iso(start);
      const mins = Math.round((act.elapsed_time || 0)/60);
      const sport = act.type || act.sport_type || 'Other';
      const intensity = mins >= 45 ? 'Hard' : mins >= 25 ? 'Moderate' : 'Easy';
      const notes = `${sport}${act.name ? ' â€” '+act.name : ''}`;
      if(addEntry(key, mins || 20, intensity, sport, notes)) added++;
    });
    save(); render(); alert(`Imported ${added} day(s) from Strava.`);
  }
  function disconnectStrava(){ if(confirm('Disconnect Strava? Tokens will be removed from this device.')){ state.strava = null; save(); render(); } }
  (function handleRedirect(){ const params = new URLSearchParams(window.location.search); const code = params.get('code'); if(code){ exchangeCode(code).then(()=>{ const url = new URL(window.location.href); url.searchParams.delete('code'); url.searchParams.delete('scope'); url.searchParams.delete('state'); window.history.replaceState({}, '', url.toString()); }).catch(()=> alert('Failed to connect to Strava.')); } })();

  $('#completeTodayBtn').addEventListener('click', addToday);
  $('#undoBtn').addEventListener('click', undoToday);
  $('#weeklyGoal').addEventListener('change', (e)=> setWeeklyGoal(e.target.value));
  $('#exportBtn').addEventListener('click', exportData);
  $('#importBtn').addEventListener('click', importData);
  $('#resetBtn').addEventListener('click', resetAll);
  $('#saveReminder').addEventListener('click', async ()=>{ const t = $('#reminderTime').value; if(!t){ state.reminder=null; save(); render(); return; } const ok = await enableNotif(); if(!ok){ alert('Notifications are blocked by your browser.'); } state.reminder = t; save(); render(); });
  $('#connectStrava').addEventListener('click', ()=>{ fetch('/.netlify/functions/strava-token?client_id=1').then(r=>r.json()).then(({client_id})=>{ if(!client_id){ alert('Server not configured.'); return; } window.location.href = stravaAuthURL(client_id); }).catch(()=> alert('Server not configured.')); });
  $('#importStrava').addEventListener('click', importRecentStrava);
  $('#disconnectStrava').addEventListener('click', disconnectStrava);

  render();
})();
</script>

</body>
</html>
