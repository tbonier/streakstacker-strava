<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Streak Stacker â€” Visuals Wave 2</title>
  <meta name="theme-color" content="#111827">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#0B1020; --card:#121A2E; --ink:#E5E7EB; --muted:#9CA3AF;
      --brand:#60A5FA; --brand-2:#34D399; --accent:#A78BFA;
      --ring:0 0 0 3px rgba(96,165,250,0.35); --radius:16px; --shadow:0 10px 25px rgba(0,0,0,0.35);
      --good:#10B981; --mid:#3B82F6; --hard:#F59E0B;
    }
    [data-theme="midnight"]{
      --bg:#090E1A; --card:#10182B; --brand:#22D3EE; --brand-2:#A78BFA; --accent:#34D399;
    }
    [data-theme="neon"]{
      --bg:#030712; --card:#0B1020; --ink:#F8FAFC; --brand:#22D3EE; --brand-2:#34D399; --accent:#F43F5E;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, #1F2937 0%, var(--bg) 60%) no-repeat;
      background-color:var(--bg);}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 64px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:30px;height:30px}
    .logo h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .hdr-meter{position:relative;height:3px;background:#0f1a33;border-radius:999px;overflow:hidden;margin:6px 0 14px;border:1px solid rgba(255,255,255,0.06)}
    .hdr-meter > div{height:100%;width:0%;background:linear-gradient(90deg, var(--brand), var(--brand-2)); transition:width .8s cubic-bezier(.2,.8,.2,1)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:1100px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .btn{background:linear-gradient(180deg, #111827, #0b1223);color:var(--ink);border:1px solid rgba(255,255,255,0.12);
      padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:transform .08s ease}
    .btn:hover{box-shadow:var(--ring)} .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg, #2563EB, #1E40AF);border-color:#1E3A8A}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,0.08)} .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap} .right{margin-left:auto}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input, select, textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
      background:#0a1122;color:var(--ink);outline:none}
    input:focus, select:focus, textarea:focus{box-shadow:var(--ring)} textarea{min-height:90px;resize:vertical}
    .stats{display:grid;grid-template-columns: repeat(4,1fr);gap:12px;margin:8px 0 4px}
    .stat{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:12px}
    .stat .k{font-size:12px;color:var(--muted)} .stat .v{font-size:22px;font-weight:700;margin-top:4px}
    .hint{color:var(--muted);font-size:12px}

    /* Ring widget */
    .ring-wrap{display:flex;gap:16px;align-items:center;margin:10px 0 12px}
    .ring{width:96px;height:96px;position:relative}
    .ring svg{transform:rotate(-90deg)}
    .ring .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700}
    .ring .sub{font-size:11px;color:var(--muted);font-weight:500}

    /* Heatmap 90d */
    .heatmap{display:grid;grid-template-columns: repeat(30, 1fr);gap:4px}
    .hm-cell{width:20px;height:20px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);position:relative}
    .hm-cell[data-lvl="0"]{background:#0b1326}
    .hm-cell[data-lvl="1"]{background:rgba(59,130,246,0.18)}
    .hm-cell[data-lvl="2"]{background:rgba(59,130,246,0.32)}
    .hm-cell[data-lvl="3"]{background:rgba(52,211,153,0.36)}
    .hm-cell[data-lvl="4"]{background:rgba(52,211,153,0.55);box-shadow:0 0 0 1px rgba(255,255,255,0.06) inset, 0 0 8px rgba(52,211,153,0.25)}
    .hm-cell:hover::after{content:attr(data-tip);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
      background:#0a1122;border:1px solid rgba(255,255,255,0.12);padding:6px 8px;border-radius:8px;font-size:11px;white-space:nowrap}

    /* Toasts */
    .toasts{position:fixed;top:14px;right:14px;display:grid;gap:8px;z-index:2000}
    .toast{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.10);
      padding:10px 12px;border-radius:12px;font-size:13px;box-shadow:var(--shadow);animation:slideIn .25s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}

    /* Confetti canvas */
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:1500}

    /* Badge shelf */
    .badges{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .badge{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));box-shadow:0 6px 16px rgba(0,0,0,0.25)}
    .badge strong{letter-spacing:.2px}
    .shelf{display:flex;align-items:center;gap:10px;margin-top:8px}
    .levelbar{flex:1;height:10px;border-radius:999px;background:#0b1326;border:1px solid rgba(255,255,255,0.08);overflow:hidden}
    .levelbar>div{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2))}

    /* Wave 2 charts */
    .charts{display:grid;gap:16px;margin-top:16px}
    @media(min-width:900px){ .charts{grid-template-columns: 1fr 1fr 1fr} }
    .chart{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:12px}
    .chart h3{margin:0 0 8px;font-size:14px;display:flex;align-items:center;justify-content:space-between}
    .sparkline{width:100%;height:80px}
    .donut{width:100%;height:200px;display:flex;align-items:center;justify-content:center}
    .intensity{height:24px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);overflow:hidden;display:flex}

    /* Theme toggle */
    .theme-toggle{display:flex;gap:6px}
    .theme-toggle button{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:#0a1122;color:var(--ink);cursor:pointer}
    .theme-toggle button.active{outline:2px solid var(--brand)}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="toasts" id="toasts"></div>

  <div class="wrap">
    <header>
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 12c4-8 12-8 16 0" stroke="url(#g1)" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 12c4 8 12 8 16 0" stroke="url(#g2)" stroke-width="2" stroke-linecap="round"/>
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0%" stop-color="#34D399"/><stop offset="100%" stop-color="#60A5FA"/>
            </linearGradient>
            <linearGradient id="g2" x1="0" x2="1">
              <stop offset="0%" stop-color="#60A5FA"/><stop offset="100%" stop-color="#34D399"/>
            </linearGradient>
          </defs>
        </svg>
        <h1>Streak Stacker</h1>
      </div>
      <div class="row">
        <div class="theme-toggle">
          <button data-theme="default" class="active">Default</button>
          <button data-theme="midnight">Midnight</button>
          <button data-theme="neon">Neon</button>
        </div>
        <button class="btn small ghost" id="exportBtn">Export</button>
        <button class="btn small ghost" id="importBtn">Import</button>
        <button class="btn small" id="installBtn" title="Install as app">Install</button>
      </div>
    </header>

    <div class="hdr-meter"><div id="hdrMeterBar"></div></div>

    <div class="grid">
      <section class="card">
        <div class="titlebar">
          <h2 style="margin:0">Today's Workout</h2>
          <div class="streak pill"><span id="streakEmoji">ðŸ”¥</span> <strong id="streakCount">0</strong>-day streak</div>
          <div class="right pill" title="Your weekly goal progress"><span id="weeklyLabel">Weekly goal</span></div>
        </div>

        <div class="ring-wrap">
          <div class="ring" title="Weekly goal progress">
            <svg width="96" height="96" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="48" stroke="rgba(255,255,255,0.08)" stroke-width="12" fill="none"/>
              <circle id="ringArc" cx="60" cy="60" r="48" stroke="url(#grad)" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="0 999"/>
              <defs>
                <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#60A5FA"/><stop offset="100%" stop-color="#34D399"/>
                </linearGradient>
              </defs>
            </svg>
            <div class="center"><div>
              <div style="font-size:18px"><span id="ringNow">0</span>/<span id="ringGoal">5</span></div>
              <div class="sub">this week</div>
            </div></div>
          </div>
          <div style="flex:1">
            <div class="stats">
              <div class="stat"><div class="k">Points</div><div class="v" id="points">0</div></div>
              <div class="stat"><div class="k">Longest Streak</div><div class="v" id="bestStreak">0</div></div>
              <div class="stat"><div class="k">This Week</div><div class="v" id="thisWeek">0/5</div></div>
              <div class="stat"><div class="k">Days This Month</div><div class="v" id="monthDays">0</div></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin:8px 0 12px">
          <button class="btn primary" id="completeTodayBtn">âœ” Mark Today Complete</button>
          <button class="btn ghost" id="undoBtn">Undo</button>
          <div class="right row">
            <label for="reminderTime" style="margin:0 8px 0 0">Daily reminder</label>
            <input type="time" id="reminderTime" style="width:auto"/>
            <button class="btn small" id="saveReminder">Save</button>
          </div>
        </div>

        <div class="row">
          <div style="flex:1;min-width:240px">
            <label>Workout type</label>
            <select id="type">
              <option>Walk</option><option>Run</option><option>Bike</option><option>Strength</option><option>Mobility</option><option>Other</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Minutes</label>
            <input id="minutes" type="number" min="0" step="1" placeholder="30"/>
          </div>
          <div style="width:140px">
            <label>Intensity</label>
            <select id="intensity"><option>Easy</option><option>Moderate</option><option>Hard</option></select>
          </div>
        </div>
        <label>Notes</label>
        <textarea id="notes" placeholder="How did it go?"></textarea>
      </section>

      <aside class="card">
        <div class="section-title">
          <h2>Badges</h2>
          <span class="pill" id="levelTag">Level 1</span>
        </div>
        <div class="badges" id="badges"></div>
        <div class="shelf">
          <div class="levelbar"><div id="levelFill"></div></div>
          <span class="pill" id="levelPct">0%</span>
        </div>

        <!-- Integrations (assumes Wave1 already merged with Strava UI) -->
        <div class="section-title" style="margin-top:16px">
          <h2>Theme</h2>
        </div>
        <div class="row">
          <div class="theme-toggle">
            <button data-theme="default" class="active">Default</button>
            <button data-theme="midnight">Midnight</button>
            <button data-theme="neon">Neon</button>
          </div>
          <span class="right hint">Theme persists on this device.</span>
        </div>

        <div class="section-title" style="margin-top:16px">
          <h2>Settings</h2>
        </div>
        <div class="row">
          <label for="weeklyGoal" style="margin:0">Weekly goal</label>
          <select id="weeklyGoal">
            <option value="3">3 days</option><option value="4">4 days</option><option value="5" selected>5 days</option><option value="6">6 days</option><option value="7">7 days</option>
          </select>
          <button class="btn small right" id="resetBtn">Reset All</button>
        </div>
      </aside>
    </div>

    <!-- Wave 2 charts -->
    <section class="charts">
      <div class="chart">
        <h3>Weekly Trend <span class="hint" id="trendHint">Last 8 weeks</span></h3>
        <svg class="sparkline" id="sparkline" viewBox="0 0 400 80" preserveAspectRatio="none"></svg>
      </div>
      <div class="chart">
        <h3>Time by Type <span class="hint" id="donutHint">This month</span></h3>
        <div class="donut">
          <svg id="donut" viewBox="0 0 200 200"></svg>
        </div>
      </div>
      <div class="chart">
        <h3>Intensity Mix <span class="hint" id="intensityHint">Last 30 days</span></h3>
        <div class="intensity" id="intensityBar"></div>
      </div>
    </section>

    <!-- Heatmap + Log -->
    <section class="card" style="margin-top:16px">
      <div class="section-title">
        <h2>Last 90 Days (heatmap)</h2>
        <span class="pill" id="heatHelp">Darker = longer/harder</span>
      </div>
      <div class="heatmap" id="heatmap"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="section-title"><h2>Log</h2></div>
      <div id="log"></div>
    </section>

    <div class="footer">
      <p>âœ¨ Visuals Wave 2: sparkline + donut + intensity bar + theme toggle. Data stays local.</p>
    </div>
  </div>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const fmt = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const iso = (d) => fmt(d).toISOString().slice(0,10);
  const today = fmt(new Date());

  // Keep v3 key but migrate from v2 if present
  const storeKey = "streakstacker.v3";
  function load(){
    try{
      const raw = localStorage.getItem(storeKey);
      if (raw && raw !== "{}") return JSON.parse(raw);
      const v2 = localStorage.getItem("streakstacker.v2");
      if (v2) return JSON.parse(v2);
      return { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null, theme:'default' };
    }catch(e){
      return { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null, theme:'default' };
    }
  }
  const state = load();
  if(!state.theme) state.theme = 'default';
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }

  // Theme handling
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme==='default' ? '' : state.theme);
    document.querySelectorAll('.theme-toggle button').forEach(b=>{
      b.classList.toggle('active', b.dataset.theme === state.theme || (state.theme==='default' && b.dataset.theme==='default'));
    });
  }
  applyTheme();
  document.querySelectorAll('.theme-toggle button').forEach(btn=>{
    btn.addEventListener('click', ()=>{ state.theme = btn.dataset.theme || 'default'; save(); applyTheme(); });
  });

  function dayDone(dateISO){ return !!state.days[dateISO]; }
  function calcStreak(){ let d = new Date(); let streak = 0; while(true){ const key = iso(d); if(state.days[key]){ streak++; d.setDate(d.getDate()-1); } else{ break; } } return streak; }
  function countThisWeek(){ const d = new Date(); const day = d.getDay(); const start = new Date(d); start.setDate(d.getDate() - day); let c = 0; for(let i=0;i<7;i++){ const k = iso(new Date(start.getFullYear(), start.getMonth(), start.getDate()+i)); if(state.days[k]) c++; } return c; }
  function countThisMonth(){ const d = new Date(); const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth()+1, 0); let c = 0; for(let i=0;i<end.getDate();i++){ const k = iso(new Date(start.getFullYear(), start.getMonth(), start.getDate()+i)); if(state.days[k]) c++; } return c; }
  function pointsForEntry(mins, intensity){ const base = 10; const dur = Math.min(50, Math.max(0, Number(mins)||0)); const bonus = Math.floor(dur/10)*2; const intMul = intensity==='Hard'? 6 : intensity==='Moderate'? 3 : 1; return base + bonus + intMul; }
  function addEntry(dateISO, minutes, intensity, type, notes){
    if(state.days[dateISO]) return false;
    const pts = pointsForEntry(minutes, intensity);
    state.days[dateISO] = { minutes:Number(minutes)||0, intensity, type, notes, points:pts };
    state.points = (state.points || 0) + pts;
    state.logs.push({date:dateISO, type, minutes:Number(minutes)||0, intensity, notes, points:pts});
    const streak = calcStreak(); if(streak > (state.best||0)) state.best = streak; return true;
  }

  // Confetti (tiny)
  const confetti = (()=>{
    const cvs = document.createElement('canvas'); cvs.id='confetti'; document.body.appendChild(cvs);
    const ctx = cvs.getContext('2d'); let w=0,h=0;
    const parts = []; const N=120;
    function resize(){ w=window.innerWidth; h=window.innerHeight; cvs.width=w; cvs.height=h; }
    function spawn(){ parts.length=0; for(let i=0;i<N;i++){ parts.push({x:Math.random()*w, y:-10-Math.random()*h*.5, vx:(Math.random()-.5)*2, vy:2+Math.random()*3, r:2+Math.random()*3, a:1}); } }
    function tick(){ ctx.clearRect(0,0,w,h); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy*=0.99; p.a-=0.004; ctx.globalAlpha=Math.max(0,p.a); ctx.fillStyle = (Math.random()<.5)?'#60A5FA':'#34D399'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(tick); }
    window.addEventListener('resize', resize); resize(); tick();
    return { burst(){ spawn(); setTimeout(()=>{parts.forEach(p=>p.a=0)},3000); } };
  })();

  // Toasts
  function toast(msg){ let wrap = document.getElementById('toasts'); if(!wrap){ wrap = document.createElement('div'); wrap.id='toasts'; wrap.className='toasts'; document.body.appendChild(wrap); } const t = document.createElement('div'); t.className='toast'; t.textContent = msg; wrap.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-4px)'; setTimeout(()=> t.remove(), 400); }, 2600); }

  function render(){
    const streak = calcStreak();
    document.getElementById('streakCount').textContent = streak;
    document.getElementById('streakEmoji').textContent = streak >= 21 ? 'ðŸ”¥' : streak >= 7 ? 'âœ¨' : 'ðŸŒ±';
    document.getElementById('bestStreak').textContent = state.best || 0;
    document.getElementById('points').textContent = state.points || 0;
    const tw = countThisWeek();
    const goal = state.weeklyGoal;
    document.getElementById('thisWeek').textContent = `${tw}/${goal}`;
    document.getElementById('monthDays').textContent = countThisMonth();
    document.getElementById('weeklyGoal').value = String(goal);

    // Header meter + ring
    const pct = Math.min(100, Math.round((tw/Math.max(1,goal))*100));
    document.getElementById('hdrMeterBar').style.width = pct+'%';
    document.getElementById('weeklyLabel').textContent = `Weekly goal â€” ${pct}%`;
    document.getElementById('ringNow').textContent = tw; document.getElementById('ringGoal').textContent = goal;
    const C = 2*Math.PI*48; const len = Math.round((pct/100)*C);
    document.getElementById('ringArc').setAttribute('stroke-dasharray', `${len} ${C}`);

    // Badges + level bar
    const b = document.getElementById('badges'); b.innerHTML='';
    const badges = [];
    const todayKey = iso(today);
    if(state.days[todayKey]) badges.push(['Today âœ…','You showed up.']);
    if(streak>=3) badges.push(['3â€‘day Streak','Momentum!']);
    if(streak>=7) badges.push(['7â€‘day Streak','One week!']);
    if(streak>=14) badges.push(['14â€‘day Streak','Fortnight flex.']);
    if(streak>=21) badges.push(['21â€‘day Streak','Habit installed.']);
    if((state.points)>=500) badges.push(['500 pts','Halfway to 1k.']);
    if((state.points)>=1000) badges.push(['1,000 pts','Monster.']);
    if(!badges.length){ b.innerHTML = '<div class="empty">No badges yet â€” let\'s earn some.</div>'; }
    else{ badges.forEach(([t,s])=>{ const el=document.createElement('div'); el.className='badge'; el.innerHTML=`<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 2l2.39 4.84 5.34.78-3.86 3.77.91 5.33L12 14.77 6.22 16.72l.91-5.33L3.27 7.62l5.34-.78L12 2z"></path></svg> <strong>${t}</strong>`; el.title=s; b.appendChild(el); }); }
    const lvl = Math.floor((state.points||0)/250)+1;
    document.getElementById('levelTag').textContent = `Level ${lvl}`;
    const toNext = (state.points||0)%250; const pctLvl = Math.min(100, Math.round((toNext/250)*100));
    document.getElementById('levelFill').style.width = pctLvl+'%'; document.getElementById('levelPct').textContent = pctLvl+'%'

    // Heatmap 90 days
    const HM = document.getElementById('heatmap'); HM.innerHTML='';
    const days = [];
    for(let i=89;i>=0;i--){ const d=new Date(); d.setDate(today.getDate()-i); days.push(d); }
    for(let i=0;i<90;i++){
      const d = days[i]; const k = iso(d);
      const entry = state.days[k];
      const mins = entry ? (entry.minutes||0) : 0;
      const intensity = entry ? entry.intensity : null;
      const lvl = entry ? (mins>=45?4:mins>=30?3:mins>=20?2:1) : 0;
      const cell = document.createElement('div'); cell.className='hm-cell'; cell.dataset.lvl = String(lvl);
      cell.dataset.tip = entry ? `${k} â€” ${entry.type} â€¢ ${mins} min â€¢ ${intensity}` : `${k} â€” no workout`;
      HM.appendChild(cell);
    }

    // Wave 2 charts
    drawSparkline(); drawDonut(); drawIntensity();
  }

  // Wave 2 chart: Weekly trend sparkline (last 8 weeks)
  function drawSparkline(){
    const svg = document.getElementById('sparkline'); svg.innerHTML='';
    const W=400, H=80; const goal = state.weeklyGoal || 5;
    const weeks = []; // each item: {done, goal}
    const end = new Date(); const endKey = iso(end);
    for(let w=7; w>=0; w--){
      const d = new Date(); d.setDate(d.getDate() - (w*7));
      const dayOfWeek = d.getDay();
      const start = new Date(d); start.setDate(d.getDate() - dayOfWeek);
      let count=0; for(let i=0;i<7;i++){ const k = iso(new Date(start.getFullYear(), start.getMonth(), start.getDate()+i)); if(state.days[k]) count++; }
      weeks.push({done:count, goal});
    }
    const maxY = Math.max(goal, ...weeks.map(w=>w.done), 7);
    const pts = weeks.map((w,i)=>{
      const x = (i/(weeks.length-1))*W;
      const y = H - (w.done/maxY)*H;
      return [x,y];
    });
    const path = pts.map((p,i)=> (i?'L':'M')+p[0].toFixed(1)+','+p[1].toFixed(1)).join(' ');
    const pl = document.createElementNS('http://www.w3.org/2000/svg','path');
    pl.setAttribute('d', path);
    pl.setAttribute('fill','none'); pl.setAttribute('stroke','url(#sg)'); pl.setAttribute('stroke-width','2');
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
    const lg = document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); lg.id='sg'; lg.setAttribute('x1','0'); lg.setAttribute('x2','1'); lg.innerHTML = '<stop offset="0%" stop-color="#60A5FA"/><stop offset="100%" stop-color="#34D399"/>';
    defs.appendChild(lg); svg.appendChild(defs); svg.appendChild(pl);
    // goal line
    const gy = H - (goal/maxY)*H; const goalLine = document.createElementNS('http://www.w3.org/2000/svg','line');
    goalLine.setAttribute('x1','0'); goalLine.setAttribute('y1',gy); goalLine.setAttribute('x2',W); goalLine.setAttribute('y2',gy);
    goalLine.setAttribute('stroke','rgba(255,255,255,0.25)'); goalLine.setAttribute('stroke-dasharray','4 4'); svg.appendChild(goalLine);
  }

  // Wave 2 chart: Donut by type (this month)
  function drawDonut(){
    const svg = document.getElementById('donut'); svg.innerHTML='';
    const R=70, Cx=100, Cy=100, T=18;
    const month = new Date().getMonth(), year = new Date().getFullYear();
    const sums = {}; const COLORS = ['#60A5FA','#34D399','#A78BFA','#F59E0B','#F87171','#22D3EE'];
    const types = ['Walk','Run','Bike','Strength','Mobility','Other'];
    types.forEach((t,i)=> sums[t]=0);
    Object.entries(state.days).forEach(([k,v])=>{
      const d = new Date(k); if(d.getMonth()===month && d.getFullYear()===year){ sums[v.type || 'Other'] += Number(v.minutes)||0; }
    });
    const values = types.map(t=> sums[t]||0);
    const total = values.reduce((a,b)=>a+b,0) || 1;
    let a0 = -Math.PI/2;
    values.forEach((val,i)=>{
      const a1 = a0 + (val/total)*Math.PI*2;
      const largeArc = (a1 - a0) > Math.PI ? 1 : 0;
      const x0 = Cx + R*Math.cos(a0), y0 = Cy + R*Math.sin(a0);
      const x1 = Cx + R*Math.cos(a1), y1 = Cy + R*Math.sin(a1);
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const d = [
        `M ${Cx} ${Cy}`,
        `L ${x0} ${y0}`,
        `A ${R} ${R} 0 ${largeArc} 1 ${x1} ${y1}`,
        'Z'
      ].join(' ');
      path.setAttribute('d', d);
      path.setAttribute('fill', COLORS[i%COLORS.length]);
      path.setAttribute('opacity', val ? '1':'0.15');
      path.setAttribute('data-tip', `${types[i]} â€” ${val} min`);
      svg.appendChild(path);
      a0 = a1;
    });
    // hole
    const hole = document.createElementNS('http://www.w3.org/2000/svg','circle');
    hole.setAttribute('cx',Cx); hole.setAttribute('cy',Cy); hole.setAttribute('r', R-T);
    hole.setAttribute('fill', 'var(--card)'); hole.setAttribute('stroke','rgba(255,255,255,0.06)'); svg.appendChild(hole);
  }

  // Wave 2 chart: Intensity mix bar (last 30 days)
  function drawIntensity(){
    const wrap = document.getElementById('intensityBar'); wrap.innerHTML='';
    const counts = { Easy:0, Moderate:0, Hard:0 };
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-30);
    Object.entries(state.days).forEach(([k,v])=>{
      const d = new Date(k); if(d >= cutoff){ counts[v.intensity||'Easy']++; }
    });
    const total = counts.Easy + counts.Moderate + counts.Hard || 1;
    const parts = [
      {label:'Easy', val:counts.Easy, color:'rgba(96,165,250,0.35)'},
      {label:'Moderate', val:counts.Moderate, color:'rgba(52,211,153,0.55)'},
      {label:'Hard', val:counts.Hard, color:'rgba(245,158,11,0.65)'}
    ];
    parts.forEach(p=>{
      const seg = document.createElement('div');
      const pct = Math.round((p.val/total)*100);
      seg.style.width = pct+'%';
      seg.style.background = p.color;
      seg.title = `${p.label} â€” ${pct}%`;
      wrap.appendChild(seg);
    });
  }

  function exportData(){ const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='streakstacker-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  function importData(){
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{
      const f=inp.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result); if(!obj.days) throw new Error('Invalid'); Object.assign(state, obj); save(); render(); } catch(e){ alert('Invalid file.'); } }; fr.readAsText(f);
    }; inp.click();
  }

  function addToday(){
    const key = iso(today); if(state.days[key]){ alert('Already logged for today. You can undo if needed.'); return; }
    const minutes = document.getElementById('minutes').value || 0;
    const intensity = document.getElementById('intensity').value;
    const type = document.getElementById('type').value;
    const notes = document.getElementById('notes').value.trim();
    if(addEntry(key, minutes, intensity, type, notes)){ save(); render(); toast('Logged!'); }
  }
  function undoToday(){
    const key = iso(today); if(!state.days[key]){ alert('Nothing to undo for today.'); return; }
    const pts = state.days[key].points || 0; delete state.days[key]; state.points = Math.max(0, (state.points||0) - pts);
    for(let i = state.logs.length - 1; i >= 0; i--){ if(state.logs[i].date === key){ state.logs.splice(i,1); break; } } save(); render();
  }

  async function enableNotif(){ if(!('Notification' in window)) return false; if(Notification.permission==='granted') return true; if(Notification.permission==='denied') return false; const p=await Notification.requestPermission(); return p==='granted'; }
  function maybeNotify(title,body){ if(!('Notification' in window)) return; if(Notification.permission!=='granted') return; new Notification(title,{body}); }
  function tickReminder(){ if(!state.reminder) return; const now=new Date(); const [hh,mm]=state.reminder.split(':').map(Number); if(now.getHours()===hh && now.getMinutes()===mm){ if(!dayDone(iso(today))){ maybeNotify('Time to move','Quick check-in: keep the streak alive.'); } } }
  setInterval(tickReminder, 60000);

  // Bindings
  document.getElementById('completeTodayBtn').addEventListener('click', addToday);
  document.getElementById('undoBtn').addEventListener('click', undoToday);
  document.getElementById('weeklyGoal').addEventListener('change', (e)=>{ state.weeklyGoal = Number(e.target.value)||5; save(); render(); });
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importBtn').addEventListener('click', importData);
  document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Delete all local data?')){ localStorage.removeItem('streakstacker.v3'); Object.assign(state, { days:{}, points:0, best:0, weeklyGoal:5, reminder:null, logs:[], strava:null, theme:'default' }); save(); render(); } });

  // Keep top header theme toggles in sync (two sets exist: header + sidebar)
  document.querySelectorAll('.theme-toggle button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.theme = btn.dataset.theme || 'default'; save(); applyTheme();
    });
  });

  render();
})();
</script>
</body>
</html>
